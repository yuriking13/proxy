name: Deploy

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        env:
          ELEVEN_API_KEY: ${{ secrets.ELEVEN_API_KEY }}
          ELEVEN_PROXY_SECRET: ${{ secrets.ELEVEN_PROXY_SECRET }}
          SYNC_API_KEY: ${{ secrets.SYNC_API_KEY }}
          PORT: "8088"
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}

          # üî• –ö–õ–Æ–ß–ï–í–û: –∏–º–µ–Ω–Ω–æ —ç—Ç–æ –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ—Ç env –≤ —É–¥–∞–ª—ë–Ω–Ω—ã–π shell
          envs: ELEVEN_API_KEY,ELEVEN_PROXY_SECRET,SYNC_API_KEY,PORT

          script: |
            set -e
            cd /opt/proxy
            git fetch origin
            git reset --hard origin/main

            npm install --omit=dev

            # –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–¥–ª–∏–Ω—ã, –±–µ–∑ —É—Ç–µ—á–∫–∏ —Å–µ–∫—Ä–µ—Ç–æ–≤)
            echo "ELEVEN_API_KEY len: ${#ELEVEN_API_KEY}"
            echo "ELEVEN_PROXY_SECRET len: ${#ELEVEN_PROXY_SECRET}"
            echo "SYNC_API_KEY len: ${#SYNC_API_KEY}"
            echo "PORT: ${PORT}"

            pm2 restart proxy --update-env || pm2 start server.js --name proxy --update-env
            pm2 save
